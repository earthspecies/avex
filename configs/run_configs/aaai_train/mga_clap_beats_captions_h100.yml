---
# Model configuration
model_spec:
  name: mga_clap
  pretrained: true
  audio_config:  # Still define for completeness; BEATs does its own Fbank conversion
    sample_rate: 16000
    representation: raw  # BEATs expects raw waveform
    normalize: false
    target_length_seconds: 10
    window_selection: random

  text_model_name: roberta-base
  projection_dim: 1024
  temperature: 0.07
  # MGA-CLAP specific parameters
  audio_encoder_name: beats
  audio_encoder_config:
    use_naturelm: false
    fine_tuned: false
  code_num: 4096  # Number of codes in modality-shared codebook
  codebook_temperature: 1000.0  # Temperature for codebook attention
  embed_regularization: true  # Whether to apply embedding regularization

dataset_config: configs/data_configs/aaai_train/data_caption_all.yml

label_type: text

# audio preprocessing
preprocessing: null

# Target sampleâ€‘rate expected by the model
sr: 16000
debug_mode: false

# Log training runs to MLflow
logging: wandb
output_dir: "./runs/aaai/mga_clap_beats_all"

# Path to checkpoint to resume from (set to null or a path)
# resume_from_checkpoint: runs/mga_clap_baseline_30_05/checkpoints/checkpoint_epoch_006.pt

training_params:
  train_epochs: 20
  lr: 0.00005
  batch_size: 128
  optimizer: adamw8bit
  weight_decay: 0.01
  amp: true
  amp_dtype: bf16
  log_steps: 100
  gradient_checkpointing: true
  gradient_clip_norm: 2.0
  skip_validation: true

# Learning rate scheduler configuration
scheduler:
  name: cosine
  warmup_steps: 5000
  min_lr: 1e-6

augmentations:
  # Add background noise at random SNRs
  - noise:
      noise_dirs:
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/demand_10s"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/idmt"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/tut2016_10s"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/urbansound"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/freesound_10s"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/\
          orcasound_shipnoise_10s"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/deepship_10s"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/shipsear_10s"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/wham_noise"
        - "/home/milad_earthspecies_org/data-migration/lambda/home/ubuntu/\
          foundation-model-storage/foundation-model-data/audio_16k/noise/audioset"
      snr_db_range: [-5, 20]  # mix noise between -5 dB and 20 dB SNR
      augmentation_prob: 0.5

# Contrastive loss for MGA-CLAP training
loss_function: contrastive

device: cuda

seed: 13

num_workers: 12

run_name: mga_clap_beats_captions

wandb_project: representation_learning

clustering_eval:
  enabled: false
  frequency: 1  # Every epoch
  layers: "last_layer"
  use_validation_set: true
  # max_samples: 1000  # Limit samples for performance
  run_before_training: true  # Run before first epoch
